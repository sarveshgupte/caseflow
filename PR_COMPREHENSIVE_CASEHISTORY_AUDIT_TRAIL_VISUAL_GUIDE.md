# Visual Guide: Comprehensive CaseHistory & Audit Trail

## ğŸ“‹ Table of Contents
1. [Case Detail Page with History](#case-detail-page-with-history)
2. [Audit Trail Display](#audit-trail-display)
3. [Tracking Flow Diagram](#tracking-flow-diagram)
4. [Data Model Structure](#data-model-structure)

---

## 1. Case Detail Page with History

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CASE DETAIL PAGE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“‹ Case: CASE-20260110-00001                                  â”‚
â”‚  Status: OPEN                    Priority: High                â”‚
â”‚  Assigned to: X123456                                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Case Details                                          â”‚  â”‚
â”‚  â”‚  Title: Customer onboarding issue                      â”‚  â”‚
â”‚  â”‚  Description: ...                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Comments                                              â”‚  â”‚
â”‚  â”‚  [Add Comment]                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Attachments                                           â”‚  â”‚
â”‚  â”‚  [Upload File]                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“œ Case History (NEW!)                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  â”Œâ”€ [CASE VIEWED] [USER]                              â”‚  â”‚
â”‚  â”‚  â”‚  John Smith viewed case                            â”‚  â”‚
â”‚  â”‚  â”‚  X123456 â€¢ 2026-01-10 10:30:15                     â”‚  â”‚
â”‚  â”‚  â”‚  IP: 192.168.1.100 (Admin only)                    â”‚  â”‚
â”‚  â”‚  â””â”€                                                    â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€ [CASE OPENED] [USER]                              â”‚  â”‚
â”‚  â”‚  â”‚  John Smith opened case                            â”‚  â”‚
â”‚  â”‚  â”‚  X123456 â€¢ 2026-01-10 10:30:00                     â”‚  â”‚
â”‚  â”‚  â””â”€                                                    â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€ [CASE ASSIGNED] [ADMIN]                           â”‚  â”‚
â”‚  â”‚  â”‚  Case assigned to John Smith                       â”‚  â”‚
â”‚  â”‚  â”‚  X999999 â€¢ 2026-01-10 10:15:00                     â”‚  â”‚
â”‚  â”‚  â””â”€                                                    â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€ [CASE CREATED] [USER]                             â”‚  â”‚
â”‚  â”‚  â”‚  Case created by Admin User                        â”‚  â”‚
â”‚  â”‚  â”‚  X999999 â€¢ 2026-01-10 10:00:00                     â”‚  â”‚
â”‚  â”‚  â””â”€                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Audit Trail Display

### Example Timeline View

```
Case History Timeline
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸŸ¢ CASE_VIEWED                    [USER]
   John Smith viewed case
   X123456 (john.smith@company.com)
   2026-01-10 10:30:15 IST
   IP: 192.168.1.100 (Admin only)
   â–¼ View Details
   {
     "userName": "John Smith",
     "timestamp": "2026-01-10T05:00:15.000Z"
   }
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸŸ¢ CASE_OPENED                    [USER]
   John Smith opened case
   X123456 (john.smith@company.com)
   2026-01-10 10:30:00 IST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ”µ CASE_ASSIGNED                  [ADMIN]
   Case assigned to John Smith
   X999999 (admin@company.com)
   2026-01-10 10:15:00 IST
   â–¼ View Details
   {
     "queueType": "PERSONAL",
     "status": "OPEN",
     "assignedTo": "X123456"
   }
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸŸ¢ CASE_CREATED                   [USER]
   Case created by Admin User
   X999999 (admin@company.com)
   2026-01-10 10:00:00 IST
   â–¼ View Details
   {
     "category": "Client - New",
     "clientId": "C000001",
     "priority": "High"
   }
```

---

## 3. Tracking Flow Diagram

```
User Journey: Opening and Viewing a Case
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. User navigates to /cases/CASE-20260110-00001
   â”‚
   â”œâ”€â†’ useEffect (mount)
   â”‚   â”œâ”€â†’ loadCase() - Fetch case data
   â”‚   â””â”€â†’ trackCaseOpen() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                   â”‚
2. Case data loaded successfully      â”‚
   â”‚                                   â”‚
   â”œâ”€â†’ useEffect (caseData ready)     â”‚
   â”‚   â””â”€â†’ setTimeout(2000ms) â”€â”€â”€â”€â”   â”‚
   â”‚                               â”‚   â”‚
3. After 2 second debounce         â”‚   â”‚
   â”‚                               â”‚   â”‚
   â””â”€â†’ trackCaseView() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤
                                   â”‚   â”‚
4. User navigates away             â”‚   â”‚
   â”‚                               â”‚   â”‚
   â””â”€â†’ Cleanup function            â”‚   â”‚
       â””â”€â†’ trackCaseExit() â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤
                                   â”‚   â”‚
5. Or user closes tab              â”‚   â”‚
   â”‚                               â”‚   â”‚
   â””â”€â†’ beforeunload event          â”‚   â”‚
       â””â”€â†’ sendBeacon() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                       â”‚
                                       â–¼
                            Backend Processing
                            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            POST /api/cases/:caseId/track-open
                            POST /api/cases/:caseId/track-view
                            POST /api/cases/:caseId/track-exit
                                       â”‚
                                       â–¼
                            Validate user & case
                            Extract IP & user agent
                            Log to CaseHistory
                                       â”‚
                                       â–¼
                            MongoDB: CaseHistory Collection
                            {
                              caseId: "CASE-20260110-00001",
                              firmId: ObjectId(...),
                              actionType: "CASE_OPENED",
                              actionLabel: "John opened case",
                              performedByXID: "X123456",
                              actorRole: "USER",
                              ipAddress: "192.168.1.100",
                              userAgent: "Mozilla/5.0...",
                              metadata: {...},
                              timestamp: ISODate(...)
                            }
```

---

## 4. Data Model Structure

### CaseHistory Document Structure

```javascript
{
  // Core Identification
  _id: ObjectId("..."),
  caseId: "CASE-20260110-00001",
  firmId: "FIRM001",
  
  // Action Details
  actionType: "CASE_VIEWED",           // From CASE_ACTION_TYPES enum
  actionLabel: "John Smith viewed case", // Human-readable
  description: "Case viewed by X123456 (John Smith)",
  
  // Actor Information
  performedByXID: "X123456",           // Canonical identifier
  performedBy: "john.smith@company.com", // Display email
  actorRole: "USER",                   // SUPER_ADMIN | ADMIN | USER | SYSTEM
  
  // Forensic Data
  ipAddress: "192.168.1.100",
  userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
  
  // Context & Metadata
  metadata: {
    userName: "John Smith",
    timestamp: "2026-01-10T05:00:15.000Z",
    // Action-specific data (no sensitive info)
  },
  
  // Timestamp (Immutable)
  timestamp: ISODate("2026-01-10T05:00:15.000Z")
}
```

### Index Structure

```javascript
// Compound Indexes
{ caseId: 1, timestamp: -1 }           // Primary query pattern
{ firmId: 1, timestamp: -1 }           // Firm-scoped audit
{ firmId: 1, caseId: 1 }               // Firm + case lookup

// Single Field Indexes
{ performedBy: 1 }                     // Legacy email lookup
{ performedByXID: 1 }                  // Canonical xID lookup
{ actionType: 1 }                      // Action filtering
{ actorRole: 1 }                       // Role-based queries
```

---

## 5. Role-Based Access Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature      â”‚ Admin   â”‚ User  â”‚ Super â”‚ System  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View History â”‚ âœ… Full â”‚ âœ… RO â”‚ âŒ No â”‚ N/A     â”‚
â”‚ See IP Addr  â”‚ âœ… Yes  â”‚ âŒ No â”‚ âŒ No â”‚ N/A     â”‚
â”‚ Track Access â”‚ âœ… Yes  â”‚ âœ… Yesâ”‚ âŒ No*â”‚ âœ… Yes  â”‚
â”‚ Export Logs  â”‚ âŒ No** â”‚ âŒ No â”‚ âŒ No â”‚ N/A     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* Superadmin cannot access case details at all
** Export feature not implemented (future work)

Legend:
âœ… = Allowed
âŒ = Blocked
RO = Read-Only
```

---

## 6. API Endpoints Summary

```
Case Tracking Endpoints (NEW)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

POST /api/cases/:caseId/track-open
  â”œâ”€ Auth: Required (User, Admin)
  â”œâ”€ Logs: CASE_OPENED
  â””â”€ Returns: 200 OK (immediate, non-blocking)

POST /api/cases/:caseId/track-view
  â”œâ”€ Auth: Required (User, Admin)
  â”œâ”€ Logs: CASE_VIEWED
  â””â”€ Returns: 200 OK (immediate, non-blocking)

POST /api/cases/:caseId/track-exit
  â”œâ”€ Auth: Required (User, Admin)
  â”œâ”€ Logs: CASE_EXITED
  â””â”€ Returns: 200 OK (immediate, non-blocking)

GET /api/cases/:caseId/history
  â”œâ”€ Auth: Required (User, Admin)
  â”œâ”€ Access: Firm-scoped, Role-based
  â””â”€ Returns: Chronological audit trail

Enhanced Existing Endpoints
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

POST /api/cases
  â””â”€ Now logs: CASE_CREATED

POST /api/cases/pull
  â””â”€ Now logs: CASE_ASSIGNED

POST /api/cases/:caseId/unassign
  â””â”€ Now logs: CASE_MOVED_TO_WORKBASKET

POST /api/cases/:caseId/resolve
  â””â”€ Now logs: CASE_RESOLVED

POST /api/cases/:caseId/pend
  â””â”€ Now logs: CASE_PENDED

POST /api/cases/:caseId/unpend
  â””â”€ Now logs: CASE_UNPENDED

POST /api/cases/:caseId/file
  â””â”€ Now logs: CASE_FILED
```

---

## 7. Color-Coded Action Types

```
Action Type Badges (Frontend Display)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸŸ¢ Green - Creation
   CASE_CREATED

ğŸ”µ Blue - Assignment
   CASE_ASSIGNED
   CASE_MOVED_TO_WORKBASKET

ğŸŸ£ Purple - Terminal States
   CASE_RESOLVED
   CASE_FILED

ğŸŸ¡ Yellow - Temporary States
   CASE_PENDED

âšª Gray - View/Access
   CASE_OPENED
   CASE_VIEWED
   CASE_EXITED

Role Badges
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”´ Red - SUPER_ADMIN
ğŸ”µ Blue - ADMIN
âšª Gray - SYSTEM
ğŸŸ¢ Green - USER
```

---

## 8. Performance Characteristics

```
Tracking Performance Metrics
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Frontend (per case view):
â”œâ”€ CASE_OPENED:  ~50ms (async, non-blocking)
â”œâ”€ CASE_VIEWED:  ~50ms (2s debounce)
â””â”€ CASE_EXITED:  ~5ms (sendBeacon)

Backend (per tracking request):
â”œâ”€ Validation:   ~10ms
â”œâ”€ DB Write:     ~20ms (indexed)
â””â”€ Total:        ~30ms

Database Impact:
â”œâ”€ Write Load:   Low (append-only)
â”œâ”€ Index Count:  +2 (actionType, actorRole)
â””â”€ Storage:      ~500 bytes per entry

Frontend Bundle:
â”œâ”€ CaseHistory Component: ~5KB
â””â”€ Service Methods: ~2KB
```

---

## 9. Compliance Features

```
Legal & Compliance Capabilities
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… Immutability
   â”œâ”€ No updates allowed
   â”œâ”€ No deletions allowed
   â””â”€ Enforced at schema level

âœ… Non-Repudiation
   â”œâ”€ Actor xID captured
   â”œâ”€ Timestamp immutable
   â””â”€ IP address logged

âœ… Forensic Trail
   â”œâ”€ User agent captured
   â”œâ”€ IP address captured
   â””â”€ Complete action history

âœ… Tenant Isolation
   â”œâ”€ Firm-scoped queries
   â”œâ”€ Access controls enforced
   â””â”€ No cross-tenant leakage

âœ… Audit Grade
   â”œâ”€ Append-only log
   â”œâ”€ Chronological ordering
   â””â”€ Complete provenance
```

---

**End of Visual Guide**
